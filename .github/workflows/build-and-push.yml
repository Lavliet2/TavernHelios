name: Build and Deploy HeliosTavern App

on:
  push:
    tags:
      - 'v*'  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set version from Git tag
        run: |
          echo "VERSION=${{ github.ref_name }}" >> $GITHUB_ENV
          echo "VITE_APP_VERSION=${{ github.ref_name }}" >> tavernhelios.client/.env
          cat tavernhelios.client/.env
          echo "VERSION=$VERSION" >> $GITHUB_ENV  #

      - name: Debug GitHub Tag
        run: |
          echo "github.ref_name=${{ github.ref_name }}"
          echo "VERSION=$VERSION"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # **–°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –±—ç–∫–µ–Ω–¥–æ–º**
      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/lavliet2/heliostavern-backend:${{ env.VERSION }}
            ghcr.io/lavliet2/heliostavern-backend:latest 

      # **–°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å MenuService**
      - name: Build and push MenuService image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./MenuService/MenuServiceServer/Dockerfile
          push: true
          tags: |
            ghcr.io/lavliet2/menuservice:${{ env.VERSION }}
            ghcr.io/lavliet2/menuservice:latest

      # # **–û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞–∑–∞ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º**
      # - name: Update image versions in Kubernetes manifests
      #   run: |
      #     sed -i "s|ghcr.io/lavliet2/heliostavern-backend:latest|ghcr.io/lavliet2/heliostavern-backend:$VERSION|g" .k8s/tavernhelios-server-deployment.yaml
      #     sed -i "s|ghcr.io/lavliet2/menuservice:latest|ghcr.io/lavliet2/menuservice:$VERSION|g" .k8s/menuservice-deployment.yaml
      #     cat .k8s/tavernhelios-server-deployment.yaml
      #     cat .k8s/menuservice-deployment.yaml

      # **–î–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞**
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} 

      - name: Deploy to Kubernetes via SSH
        env:
          DEPLOY_VERSION: ${{ env.VERSION }} 
        run: |
          ssh -o StrictHostKeyChecking=no -p 2222 lavliet@178.72.83.217 << 'EOF'          
          set -e  # –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

          echo '–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞ 1.0.7.4'
      
          export TAG=\"${DEPLOY_VERSION}\"
          echo \"TAG: \$TAG\"
    
          if [[ -z \"\$TAG\" ]]; then
            echo '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è TAG –ø—É—Å—Ç–∞—è, –¥–µ–ø–ª–æ–∏–º main'
            TAG='main'
          fi
    
          echo 'üöÄ Deploying version:' \"\$TAG\"
      
          echo "Deploying version: $TAG"
      
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é
          rm -rf /home/lavliet/heliostavern-app
      
          if git ls-remote --tags https://github.com/Lavliet2/TavernHelios.git | grep -q \"refs/tags/\$TAG\"; then
            echo '‚úÖ –ù–∞–π–¥–µ–Ω —Ç–µ–≥:' \"\$TAG\", '–∫–ª–æ–Ω–∏—Ä—É–µ–º main –∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è...'
            git clone --branch main --depth 1 https://github.com/Lavliet2/TavernHelios.git /home/lavliet/heliostavern-app
            cd /home/lavliet/heliostavern-app || exit 1
            git fetch --tags
            git checkout \"\$TAG\"
          elif git ls-remote --heads https://github.com/Lavliet2/TavernHelios.git | grep -q \"refs/heads/\$TAG\"; then
            echo '‚úÖ –ù–∞–π–¥–µ–Ω–∞ –≤–µ—Ç–∫–∞:' \"\$TAG\", '–∫–ª–æ–Ω–∏—Ä—É–µ–º –µ—ë...'
            git clone --branch \"\$TAG\" --depth 1 https://github.com/Lavliet2/TavernHelios.git /home/lavliet/heliostavern-app
          else
            echo '‚ùå –û—à–∏–±–∫–∞: –í–µ—Ç–∫–∞ –∏–ª–∏ —Ç–µ–≥' \"\$TAG\" '–Ω–µ –Ω–∞–π–¥–µ–Ω—ã, –¥–µ–ø–ª–æ–∏–º main!'
            git clone --branch 'main' --depth 1 https://github.com/Lavliet2/TavernHelios.git /home/lavliet/heliostavern-app
          fi
      
          cd /home/lavliet/heliostavern-app || exit 1
      
          # –î–µ–ø–ª–æ–π –≤ Kubernetes
          kubectl apply -f .k8s/tavernhelios-ingress.yaml || exit 1
          kubectl apply -f .k8s/mongo-deployment.yaml || exit 1
          kubectl apply -f .k8s/menuservice-deployment.yaml || exit 1
          kubectl apply -f .k8s/tavernhelios-server-deployment.yaml || exit 1
      
          # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ—Å—Ç–∞—Ä—Ç –ø–æ–¥–æ–≤
          echo " –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—ã..."
          kubectl rollout restart deployment tavernhelios-server || exit 1
          kubectl rollout restart deployment menuservice || exit 1
      
          echo "–î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          EOF
        
