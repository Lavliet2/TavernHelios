name: Build and Deploy HeliosTavern App

on:
  push:
    tags:
      - 'v*'  
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set version from Git tag
        run: |
          VERSION=${{ github.ref_name }}  
          echo "Current version: $VERSION"        
          echo "VITE_APP_VERSION=$VERSION" >> tavernhelios.client/.env
          cat tavernhelios.client/.env
          echo "VERSION=$VERSION" >> $GITHUB_ENV  #

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # **–°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å –±—ç–∫–µ–Ω–¥–æ–º**
      - name: Build and push backend image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ghcr.io/lavliet2/heliostavern-backend:${{ env.VERSION }}
            ghcr.io/lavliet2/heliostavern-backend:latest 

      # **–°–±–æ—Ä–∫–∞ –∏ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å MenuService**
      - name: Build and push MenuService image
        uses: docker/build-push-action@v4
        with:
          context: .
          file: ./MenuService/MenuServiceServer/Dockerfile
          push: true
          tags: |
            ghcr.io/lavliet2/menuservice:${{ env.VERSION }}
            ghcr.io/lavliet2/menuservice:latest

      # **–û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞–∑–∞ –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º**
      - name: Update image versions in Kubernetes manifests
        run: |
          sed -i "s|ghcr.io/lavliet2/heliostavern-backend:latest|ghcr.io/lavliet2/heliostavern-backend:$VERSION|g" .k8s/tavernhelios-server-deployment.yaml
          sed -i "s|ghcr.io/lavliet2/menuservice:latest|ghcr.io/lavliet2/menuservice:$VERSION|g" .k8s/menuservice-deployment.yaml
          cat .k8s/tavernhelios-server-deployment.yaml
          cat .k8s/menuservice-deployment.yaml

      # **–î–µ–ø–ª–æ–π –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞**
      - name: Add SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }} 

      - name: Deploy to Kubernetes via SSH
        run: |
          ssh -o StrictHostKeyChecking=no -p 2222 lavliet@178.72.83.217 << EOF
          set -e  # ‚úÖ –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        
          TAG="${VERSION#v}"  # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 'v'
          echo "Deploying version: $TAG"
        
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–∞–∫–æ–π —Ç–µ–≥
          if ! git ls-remote --tags https://github.com/Lavliet2/TavernHelios.git | grep -q "refs/tags/\$TAG"; then
            echo "‚ùå –û—à–∏–±–∫–∞: –¢–µ–≥ \$TAG –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏!"
            exit 1
          fi
        
          # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∏ –∫–ª–æ–Ω–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–π —Ç–µ–≥
          rm -rf /home/lavliet/heliostavern-app || exit 1
          git clone --branch \$TAG --depth 1 https://github.com/Lavliet2/TavernHelios.git /home/lavliet/heliostavern-app || exit 1
        
          cd /home/lavliet/heliostavern-app || exit 1
        
          # –î–µ–ø–ª–æ–π –≤ Kubernetes
          kubectl apply -f .k8s/tavernhelios-ingress.yaml || exit 1
          kubectl apply -f .k8s/mongo-deployment.yaml || exit 1
          kubectl apply -f .k8s/menuservice-deployment.yaml || exit 1
          kubectl apply -f .k8s/tavernhelios-server-deployment.yaml || exit 1
        
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤..."
          kubectl get pods -o wide || exit 1
        
            # –†–µ—Å—Ç–∞—Ä—Ç –ø–æ–¥–æ–≤
          kubectl rollout restart deployment tavernhelios-server || exit 1
          kubectl rollout restart deployment menuservice || exit 1
        
          echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à—ë–Ω!"
          EOF
        